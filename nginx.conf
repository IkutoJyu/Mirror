#user  nobody;
worker_processes  auto;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    # access_log  logs/access.log  main;

    sendfile        on;

    keepalive_timeout  65;

    # for mobile redirect to desktop for reverse
    proxy_redirect https://zh.m.wikipedia.org/ https://mwiki.upupming.site/;
    proxy_redirect https://zh.wikipedia.org/ https://wiki.upupming.site/;

    proxy_cookie_domain zh.wikipedia.org wiki.upupming.site;
    proxy_cookie_domain zh.m.wikipedia.org m.wiki.upupming.site;
    proxy_cookie_domain upload.wikimedia.org upwiki.upupming.site;
    proxy_cookie_domain wikipedia.org wiki.upupming.site;
    proxy_cookie_domain www.google.com google.upupming.site;
    proxy_cookie_domain google.com google.upupming.site;
    proxy_cookie_domain ipv6.google.com google.upupming.site;
    proxy_cookie_domain ipv4.google.com ipv4.google.upupming.site;
    proxy_cookie_domain maps.google.com maps.google.upupming.site;
    proxy_cookie_domain code.google.com code.google.upupming.site;
    proxy_cookie_domain translate.google.com translate.google.upupming.site;
    proxy_cookie_domain docs.google.com docs.google.upupming.site;
    proxy_cookie_domain photos.google.com photos.google.upupming.site;
    proxy_cookie_domain scholar.google.com scholar.google.upupming.site;
    proxy_cookie_domain accounts.google.com accounts.google.upupming.site;

	  proxy_set_header User-Agent $http_user_agent;
	  proxy_set_header Accept-Encoding "";
	  proxy_set_header X-Real-IP $remote_addr; 
	  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
	  proxy_set_header X-Forwarded-Proto https;
    # open as new window, very important! or subs_filter won't work
    # but clients won't be able to change their languages!
  	proxy_set_header Cookie "";
    
    # substitute text mimeTypes
    subs_filter_types text/css text/xml application/json;
    # wikipedia replacement
    subs_filter zh.wikipedia.org wiki.upupming.site;
    subs_filter zh.m.wikipedia.org mwiki.upupming.site;
    subs_filter upload.wikimedia.org upwiki.upupming.site;

    # google replacement
	  subs_filter www.google.com.hk google.upupming.site;
	  subs_filter www.google.com google.upupming.site;
	  subs_filter google.com google.upupming.site;

    subs_filter ssl.gstatic.com ssl.gstatic.upupming.site;
    subs_filter gstatic.com gstatic.upupming.site;
    subs_filter www.gstatic.com www.gstatic.upupming.site;

    # add my styles
    subs_filter <head> '
      <head>
        <!-- Global site tag (gtag.js) - Google Analytics -->
          <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114899088-2"></script>
          <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag("js", new Date());

            gtag("config", "UA-114899088-2");
          </script>   

          <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
          <script>
            (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-2188191456032650",
              enable_page_level_ads: true
            });
          </script>    
          <link rel="stylesheet" type="text/css" href="https://mirror.upupming.site/css/upupming-Mirror.css">
    ';

    # add a footer
    subs_filter </body> '
        <my-footer style="background-color:white">
          <div class="container font-kai" id="about" style="background-color:white">
            <!-- Copyright information-->    
            <p style="color:black"><a href="https://mirror.upupming.site/">所有镜像站点</a>在<a href="https://wiki.upupming.site/zh-cn/Wikipedia%3ACC_BY-SA_3.0协议文本">知识共享 署名-相同方式共享 3.0协议</a>之条款下提供</p>
            <ul class="list-inline">
              <li class="list-inline-item">
                <a href="https://upupming.site" style="color:#4ba8e9">Blog</a>
              </li>
              <li class="list-inline-item">
                <a href="https://github.com/upupming/" style="color:#4ba8e9">GitHub</a>
              </li>
              <li class="list-inline-item">
                <a href="mailto:upupming@gmail.com" style="color:#4ba8e9">E-mail</a>
              </li>
            </ul>

            <!-- busuanzi -->
            <div class="busuanzi" style="color:black"><script async="" src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display: inline;"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv" style="display: inline;"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div>
          
          </div>
        </my-footer>
      </body>';
    

    
    ##### Wikipedia desktop
    server {
	    server_name wiki.upupming.site;
	    listen 80;
        return 301 https://$server_name$request_uri;
    }
    server {
	    server_name wiki.upupming.site;
	    listen 443 ssl;

        ssl on;
        ssl_certificate      /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

	    location / {
		    proxy_pass https://zh.wikipedia.org;    
	    }
        location https://zh.wikipedia.org/ {
            return 301 https://wiki.upupming.site$request_uri;
        }
        location https://zh.m.wikipedia.org/ {
            return 301 https://mwiki.upupming.site$request_uri;
        }
    }
    ##### Wikipedia mobile
    server {
	    server_name mwiki.upupming.site;
	    listen 80;
        return 301 https://$server_name$request_uri;
    }
    server {
	    server_name mwiki.upupming.site;
	    listen 443 ssl;

        ssl on;
        ssl_certificate      /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

	    location / {
		    proxy_pass https://zh.m.wikipedia.org;
                # add my styles
            subs_filter <head> '
              <head>
                <!-- Global site tag (gtag.js) - Google Analytics -->
                <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114899088-2"></script>
                <script>
                  window.dataLayer = window.dataLayer || [];
                  function gtag(){dataLayer.push(arguments);}
                  gtag("js", new Date());

                  gtag("config", "UA-114899088-2");
                </script>   

              <!-- Goolge Adsense -->
                <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                <script>
                  (adsbygoogle = window.adsbygoogle || []).push({
                    google_ad_client: "ca-pub-2188191456032650",
                    enable_page_level_ads: true
                  });
                </script>    
                <link rel="stylesheet" type="text/css" href="https://mirror.upupming.site/css/upupming-Mirror.css">
            ';

            subs_filter </body> '</body>';
            subs_filter '桌面版</a></li>' '桌面版</a></li>
	            <my-footer style="background-color:white">
                <div class="container font-kai" id="about" style="background-color:white">
                  <!-- Copyright information-->
                  <p style="color:black"><a href="https://mirror.upupming.site/">所有镜像站点</a>在<a href="https://wiki.upupming.site/zh-cn/Wikipedia%3ACC_BY-SA_3.0协议文本">知识共享 署名-相同方式共享 3.0协议</a>之条款下提供</p>
                  <ul class="list-inline">
                    <li class="list-inline-item">
                      <a href="https://upupming.site" style="color:#4ba8e9">Blog</a>
                    </li>
                    <li class="list-inline-item">
                      <a href="https://github.com/upupming/" style="color:#4ba8e9">GitHub</a>
                    </li>
                    <li class="list-inline-item">
                      <a href="mailto:upupming@gmail.com" style="color:#4ba8e9">E-mail</a>
                    </li>
                  </ul>

                  <!-- busuanzi -->
                  <div class="busuanzi" style="color:black"><script async="" src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" style="display: inline;"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv" style="display: inline;"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div>

                </div>
              </my-footer>';
            subs_filter zh.wikipedia.org wiki.upupming.site;
	    }
        location https://zh.m.wikipedia.org/{
            rewrite ^/(.*) https://mwiki.upupming.site/$1 permanent;
        }
        location https://zh.wikipedia.org/{
            rewrite ^/(.*) https://wiki.upupming.site/$1 permanent;
        }
    }
    ##### Wikipedia upload
    server {
	    server_name upwiki.upupming.site;
	    listen 80;
        return 301 https://$server_name$request_uri;
    }
    server {
	    server_name upwiki.upupming.site;
	    listen 443 ssl;

        ssl on;
        ssl_certificate      /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;
        
        location / {
            proxy_pass https://upload.wikimedia.org;
	    }

        location https://zh.m.wikipedia.org/{
            rewrite ^/(.*) https://mwiki.upupming.site/$1 permanent;
        }
        location https://zh.wikipedia.org/{
            rewrite ^/(.*) https://wiki.upupming.site/$1 permanent;
        }
    }



    ##### Google search(using ipv6)
    server {
	    server_name google.upupming.site;
        listen 80;	
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443;
        server_name google.upupming.site;
        ssl on;
        ssl_certificate      /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {	
	    proxy_pass https://ipv6.google.com;
        }
        location /maps {
            proxy_pass https://www.google.com/maps;
        }
    }
    ##### Google ipv4
    server {
	    server_name ipv4.google.upupming.site;
        listen 80;	
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443;
        server_name ipv4.google.upupming.site;

        ssl on;
        ssl_certificate      /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {
            proxy_pass https://ipv4.google.com;
        }

        location /maps {
            proxy_pass https://www.google.com/maps;
        }        
    }
    ##### Google gstatic
    server {
	    server_name gstatic.upupming.site;
        listen 80;	
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443;
        server_name gstatic.upupming.site;

        ssl on;
        ssl_certificate      /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {
            proxy_pass https://gstatic.com;
        }
    }
    ##### Google www.gstatic
    server {
	    server_name www.gstatic.upupming.site;
        listen 80;	
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443;
        server_name www.gstatic.upupming.site;

        ssl on;
        ssl_certificate      /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {
            proxy_pass https://www.gstatic.com;
        }
    }
    ##### Google ssl.gstatic
    server {
	    server_name ssl.gstatic.upupming.site;
        listen 80;	
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443;
        server_name ssl.gstatic.upupming.site;

        ssl on;
        ssl_certificate      /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {
            proxy_pass https://ssl.gstatic.com;
        }
    }
    ##### Google encrypted-tbn0.gstatic
    server {
	    server_name encrypted-tbn0.gstatic.upupming.site;
        listen 80;	
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443;
        server_name encrypted-tbn0.gstatic.upupming.site;

        ssl on;
        ssl_certificate      /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {
            proxy_pass https://encrypted-tbn0.gstatic.com;
        }
    }
    ##### Google scholar
    server {
	    server_name scholar.google.upupming.site;
	    listen 80;
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443 ssl;
        server_name scholar.google.upupming.site;

        ssl on;
        ssl_certificate      /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {
            proxy_pass https://scholar.google.com;
        }
    }
    ##### Google accounts
    server {
	    server_name accounts.google.upupming.site;
	    listen 80;
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443 ssl;
        server_name accounts.google.upupming.site;

        ssl on;
        ssl_certificate      /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {
            proxy_pass https://accounts.google.com;
        }
    }
    ##### Google maps
    server {
	    server_name maps.google.upupming.site;
	    listen 80;
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443 ssl;
        server_name maps.google.upupming.site;

        ssl on;
        ssl_certificate      /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {
            return 301 https://google.upupming.site/maps;
        }
    }
    ##### Google Translate
    server {
	    server_name translate.google.upupming.site;
	    listen 80;
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443 ssl;
        server_name translate.google.upupming.site;

        ssl on;
        ssl_certificate /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {
            proxy_pass https://translate.google.com;
        }
    }
    ##### Google Photos
    server {
	    server_name photos.google.upupming.site;
	    listen 80;
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443 ssl;
        server_name photos.google.upupming.site;

        ssl on;
        ssl_certificate /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {
            proxy_pass https://photos.google.com;
        }
    }
    ##### Google Docs
    server {
	    server_name docs.google.upupming.site;
	    listen 80;
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443 ssl;
        server_name docs.google.upupming.site;

        ssl on;
        ssl_certificate /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {
            proxy_pass https://docs.google.com;
        }
    }
    ##### Google Code
    server {
	    server_name code.google.upupming.site;
	    listen 80;
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443 ssl;
        server_name code.google.upupming.site;

        ssl on;
        ssl_certificate /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {
            proxy_pass https://code.google.com;
        }
        location /codejam/ {
            proxy_pass https://code.google.com/codejam/;
        }
    }



    ##### upupming Mirror
    server {
	    server_name mirror.upupming.site;
	    listen 80;
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443 ssl;
        server_name mirror.upupming.site;

        ssl on;
        ssl_certificate /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;

        location / {
            root /home/wwwroot/Mirror;
            index index.html index.htm;
        }
    }




    ##### gitea
    server {
	    server_name git.upupming.site;
	    listen 80;
        return 301 https://$server_name$request_uri;
    }
    server {
        listen 443 ssl;
        server_name git.upupming.site;

        subs_filter </body> '</body>';
        
        # git push
        client_max_body_size 50m;
        
        ssl on;
        ssl_certificate      /etc/letsencrypt/live/upupming.site/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/upupming.site/privkey.pem;
        
        location / {
            proxy_pass http://localhost:3000;
        }
    }
